<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#030303">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="https://fv5-5.files.fm/thumb_show.php?i=fmpaauyhdk&view&v=1">
    <link rel="apple-touch-icon" href="https://fv5-5.files.fm/thumb_show.php?i=fmpaauyhdk&view&v=1">
    <title>Meta Officiel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://player.vimeo.com/api/player.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* CSS INCHANG√â POUR GAGNER DE LA PLACE, MAIS IDENTIQUE AU PR√âC√âDENT */
        :root { --bg-color: #030303; --surface: #111111; --border: #222222; --text-main: #ffffff; --text-sec: #888888; --accent: #D4AF37; --accent-text: #000000; --card-shadow: 0 10px 30px rgba(0,0,0,0.5); --vh: 1vh; --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px); }
        body[data-accent="gold"] { --accent: #D4AF37; --accent-text: #000000; }
        body[data-accent="blue"] { --accent: #007AFF; --accent-text: #ffffff; }
        body[data-accent="white"] { --accent: #FFFFFF; --accent-text: #000000; }
        body.light-mode { --bg-color: #F5F5F7; --surface: #FFFFFF; --border: #E0E0E0; --text-main: #1D1D1F; --text-sec: #86868B; --card-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        body.light-mode[data-accent="black"] { --accent: #1D1D1F; --accent-text: #FFFFFF; }
        body.light-mode[data-accent="blue"] { --accent: #007AFF; --accent-text: #FFFFFF; }
        body.light-mode[data-accent="grey"] { --accent: #555555; --accent-text: #FFFFFF; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: var(--bg-color); }
        body { font-family: 'Montserrat', sans-serif; height: calc(var(--vh, 1vh) * 100); color: var(--text-main); transition: all 0.4s ease; -webkit-font-smoothing: antialiased; }
        .btn-press:active { transform: scale(0.96); opacity: 0.8; transition: 0.1s; }
        .glass { backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 30px; }
        .loader-icon { width: 80px; height: 80px; border-radius: 20px; background-image: url('https://fv5-5.files.fm/thumb_show.php?i=fmpaauyhdk&view&v=1'); background-size: cover; background-position: center; box-shadow: 0 0 20px rgba(212, 175, 50, 0.3); margin-bottom: 20px; }
        .loader-text { margin-top: 15px; font-family: 'Cormorant Garamond', serif; color: var(--accent); letter-spacing: 4px; font-size: 0.9rem; text-transform: uppercase; text-align: center; }
        .install-block-text { margin-top: 30px; font-size: 0.85rem; color: #fff; text-align: center; max-width: 320px; line-height: 1.8; }
        .install-steps { text-align: left; margin-top: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .install-step { margin-bottom: 10px; font-size: 0.8rem; color: #ddd; }
        .install-step strong { color: var(--accent); }
        #app-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #onboarding-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; overflow-y: auto; }
        .ob-title { font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; color: #fff; margin-bottom: 10px; }
        .ob-subtitle { font-size: 0.8rem; color: #666; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 50px; }
        .ob-step { display: none; width: 100%; max-width: 350px; }
        .ob-step.active { display: block; }
        .ob-options { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .ob-btn { padding: 20px; border: 1px solid #333; background: transparent; color: #fff; font-family: 'Montserrat', sans-serif; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: all 0.3s; border-radius: 12px; }
        .ob-btn.selected { border-color: var(--accent); background: rgba(255,255,255,0.05); color: var(--accent); }
        .color-options { display: flex; justify-content: center; gap: 25px; margin-top: 10px; }
        .color-circle { width: 65px; height: 65px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #fff; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.2s; }
        .color-circle.active { border-color: #fff; transform: scale(1.1); }
        .cc-gold { background: #D4AF37; color: #000; } .cc-blue { background: #007AFF; } .cc-white { background: #FFF; color: #000; } .cc-black { background: #1D1D1F; } .cc-grey { background: #555; }
        .ob-validate-btn { margin-top: 40px; padding: 15px 40px; background: #fff; color: #000; border: none; font-weight: 600; letter-spacing: 1px; cursor: pointer; border-radius: 12px; }
        .ob-validate-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 40px; }
        .logo { font-family: 'Cormorant Garamond', serif; font-size: 3.5rem; font-weight: 300; margin-bottom: 60px; letter-spacing: 8px; color: var(--text-main); text-transform: uppercase; text-align: center; width: 100%; }
        input { width: 100%; max-width: 320px; padding: 20px; background: transparent; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; font-size: 14px; color: var(--text-main); font-family: 'Montserrat', sans-serif; text-align: center; }
        input:focus { border-color: var(--accent); }
        .login-btn { width: 100%; max-width: 320px; background: transparent; color: var(--accent); padding: 20px; border: 1px solid var(--accent); border-radius: 12px; font-weight: 500; cursor: pointer; text-transform: uppercase; letter-spacing: 3px; transition: 0.3s; }
        #login-error { color: #ff4d4d; font-size: 0.8rem; margin-top: 15px; display: none; font-weight: 500; }
        header { height: calc(60px + var(--safe-top)); padding-top: var(--safe-top); border-bottom: 1px solid var(--border); display: none; justify-content: center; align-items: center; position: relative; padding-left: 15px; padding-right: 15px; background: transparent; z-index: 100; flex-shrink: 0; }
        header span { font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; font-weight: 600; color: var(--text-main); text-transform: uppercase; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-left { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); }
        .header-right { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: flex; gap: 15px; }
        .stories-container { display: flex; overflow-x: auto; padding: 20px 15px; gap: 25px; background: transparent; border-bottom: 1px solid var(--border); scrollbar-width: none; }
        .stories-container::-webkit-scrollbar { display: none; }
        .story-bubble { display: flex; flex-direction: column; align-items: center; min-width: 70px; cursor: pointer; border: none; background: none; }
        .story-img-wrapper { width: 60px; height: 60px; border-radius: 50%; background: var(--bg-color); border: 2px solid var(--accent); overflow: hidden; display: flex; justify-content: center; align-items: center; padding: 2px; }
        .story-img-wrapper img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .story-name { font-size: 0.65rem; color: var(--text-sec); text-align: center; white-space: nowrap; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; margin-top: 8px; }
        #main-app { display: none; flex-direction: column; height: 100%; width: 100%; }
        .content-area { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .section { height: 100%; width: 100%; position: absolute; top: 0; left: 0; visibility: hidden; opacity: 0; background: var(--bg-color); overflow-y: auto; scrollbar-width: none; }
        .section.active { visibility: visible; opacity: 1; z-index: 1; }
        .section::-webkit-scrollbar { display: none; }
        .post { background: var(--surface); margin: 20px auto; max-width: 500px; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); }
        .post-user { padding: 15px; font-weight: 500; display: flex; align-items: center; gap: 12px; font-size: 0.8rem; cursor: pointer; color: var(--text-main); text-transform: uppercase; letter-spacing: 1px; }
        .post-user .mini-avatar { width: 30px; height: 30px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--border); }
        .post-img-container { position: relative; cursor: pointer; user-select: none; }
        .post-img-container img { width: 100%; display: block; object-fit: cover; }
        .like-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); pointer-events: none; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .like-overlay.animate { animation: like-anim 0.6s ease-out forwards; }
        @keyframes like-anim { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        .post-actions { padding: 15px; display: flex; justify-content: flex-end; border-top: 1px solid var(--border); }
        .action-btn { background: transparent; border: none; padding: 8px; cursor: pointer; color: var(--text-sec); font-size: 1.2rem; }
        .action-btn.saved { color: var(--accent); }
        #videos-section { background: #000; overflow-y: scroll; scroll-snap-type: y mandatory; }
        .video-card { height: 100%; width: 100%; scroll-snap-align: start; position: relative; display: flex; align-items: center; justify-content: center; }
        .video-thumb { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index: 1; }
        .video-play-overlay { position: absolute; z-index: 2; color: rgba(255,255,255,0.8); font-size: 4rem; pointer-events: none; }
        .video-card iframe { width: 100%; height: 100%; border: none; position: absolute; top:0; left:0; z-index: 0; opacity: 0; transition: opacity 0.3s; }
        .video-card.playing iframe { opacity: 1; z-index: 5; }
        .video-card.playing .video-thumb, .video-card.playing .video-play-overlay { opacity: 0; pointer-events: none; }
        .video-sidebar { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; z-index: 10; align-items: center; }
        .sidebar-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .sidebar-btn span { font-size: 0.7rem; font-weight: 500; }
        .sidebar-btn.saved { color: var(--accent); }
        .video-info { position: absolute; bottom: 90px; left: 20px; color: white; z-index: 10; text-shadow: 0 2px 10px rgba(0,0,0,0.8); width: 65%; }
        .video-info h3 { font-family: 'Cormorant Garamond', serif; color: var(--accent); font-size: 1.2rem; }
        .seen-badge { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: #fff; padding: 5px 10px; border-radius: 20px; font-size: 0.6rem; text-transform: uppercase; z-index: 5; }
        .overlay-page { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 600; overflow-y: auto; padding-top: calc(35px + var(--safe-top)); transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        .overlay-page.active { transform: translateX(0); visibility: visible; }
        nav { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; z-index: 999; height: 65px; padding-bottom: var(--safe-bottom); background: var(--bg-color); border-top: 1px solid var(--border); box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .nav-indicator { position: absolute; top: 0; width: 25px; height: 2px; background: var(--accent); border-radius: 3px; left: 0; }
        nav button.nav-item { background: none; border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; width: 50px; height: 40px; display: flex; align-items: center; justify-content: center; }
        nav button.nav-item.active { color: var(--accent); transform: translateY(-1px); }
        body.has-overlay nav { display: none; }
        .profile-header { padding: 40px 20px; text-align: center; }
        .profile-pic-main { width: 90px; height: 90px; background: #111; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent); border: 1px solid var(--accent); }
        .profile-stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 25px; color: var(--text-sec); }
        .stat-num { display: block; font-size: 1.2rem; color: var(--text-main); font-weight: 600; margin-bottom: 5px; }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; }
        .profile-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .p-tab { flex: 1; padding: 15px; text-align: center; color: var(--text-sec); cursor: pointer; font-size: 0.7rem; letter-spacing: 3px; border-bottom: 1px solid transparent; background: none; }
        .p-tab.active { color: var(--text-main); border-bottom: 1px solid var(--accent); }
        .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; padding: 1px; background: var(--border); margin-bottom: 100px; }
        .grid-item { aspect-ratio: 1/1; background: var(--surface); overflow: hidden; border: none; padding: 0; position: relative; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .grid-item .vid-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 1.5rem; text-shadow: 0 2px 5px rgba(0,0,0,0.8); pointer-events: none; }
        .header-btn { background: none; border: none; color: var(--text-sec); font-size: 1.1rem; cursor: pointer; padding: 5px; }
        .settings-group { padding: 20px; border-bottom: 1px solid var(--border); }
        .settings-title { font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; margin-bottom: 15px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .settings-label { font-size: 0.85rem; letter-spacing: 1px; color: var(--text-sec); text-transform: uppercase; }
        .picker-colors { display: flex; gap: 15px; }
        .picker-circle { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .picker-circle.active { border-color: var(--text-main); transform: scale(1.1); }
        .empty-state { grid-column: 1 / -1; padding: 40px 20px; text-align: center; color: var(--text-sec); }
        .toggle-switch { width: 50px; height: 28px; background-color: var(--border); border-radius: 14px; position: relative; cursor: pointer; transition: background-color 0.3s; }
        .toggle-switch.active { background-color: var(--accent); }
        .toggle-knob { width: 22px; height: 22px; background-color: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle-switch.active .toggle-knob { transform: translateX(22px); }
        #messages-section { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background: var(--bg-color); overflow-y: auto; }
        .msg-list-header { padding: 15px; border-bottom: 1px solid var(--border); min-height: 60px; padding-top: calc(20px + var(--safe-top)); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; background: var(--bg-color); z-index: 10; }
        .msg-list-title { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .msg-list-content { padding-top: 15px; padding-bottom: 100px; }
        .msg-list-item { display: flex; align-items: center; gap: 15px; padding: 15px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .msg-list-item:active { background: var(--surface); }
        .msg-avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; color: var(--accent-text); font-size: 1.2rem; overflow: hidden; flex-shrink: 0; }
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .msg-info { flex: 1; }
        .msg-info h4 { font-size: 1rem; font-weight: 500; color: var(--text-main); margin-bottom: 4px; }
        .msg-info p { font-size: 0.85rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #chat-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1100; display: none; flex-direction: column; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
        #chat-page.active { display: flex; transform: translateY(0); }
        .chat-top-bar { padding: 15px; border-bottom: 1px solid var(--border); min-height: 60px; padding-top: calc(20px + var(--safe-top)); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: var(--bg-color); z-index: 2; }
        .chat-top-title { font-size: 1.1rem; font-weight: 600; color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .chat-top-close { background: none; border: none; color: var(--text-sec); cursor: pointer; font-size: 1.3rem; padding: 5px; }
        .chat-msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; padding-bottom: 150px; -webkit-overflow-scrolling: touch; }
        .chat-msg-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; white-space: pre-wrap; position: relative; }
        .chat-msg-bubble.user { background: var(--accent); color: var(--accent-text); align-self: flex-end; border-bottom-right-radius: 4px; margin-left: auto; }
        .chat-msg-bubble.other, .chat-msg-bubble.bot { background: var(--surface); align-self: flex-start; border-bottom-left-radius: 4px; margin-right: auto; }
        .msg-delete-btn { position: absolute; bottom: -25px; right: 10px; font-size: 0.6rem; color: #ff4d4d; background: rgba(0,0,0,0.8); padding: 3px 8px; border-radius: 10px; cursor: pointer; display: none; z-index: 5; }
        .chat-msg-bubble.user.show-delete .msg-delete-btn { display: block; }
        .chat-input-container { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); padding: 10px 15px; padding-bottom: calc(25px + var(--safe-bottom)); display: flex; flex-direction: column; z-index: 3; }
        .chat-msg-preview { min-height: 24px; font-size: 1rem; color: var(--text-main); margin-bottom: 10px; opacity: 0.9; word-break: break-word; }
        .chat-msg-preview:empty::before { content: "√âcrivez votre message..."; color: var(--text-sec); opacity: 0.5; }
        .chat-input-row { display: flex; gap: 10px; align-items: center; }
        .chat-text-input { flex: 1; background: var(--bg-color); border: 1px solid var(--border); border-radius: 20px; padding: 12px 15px; color: var(--text-main); font-size: 1rem; outline: none; }
        .chat-send-btn { background: var(--accent); color: var(--accent-text); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .scroll-down-btn { position: fixed; bottom: 160px; right: 20px; width: 45px; height: 45px; background: var(--surface); border-radius: 50%; display: none; align-items: center; justify-content: center; color: var(--accent); font-size: 1.2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 4; border: 1px solid var(--border); }
        .scroll-down-btn.show { display: flex; }
        #notif-banner { position: fixed; top: 0; left: 0; width: 100%; background: var(--surface); color: var(--text-main); padding: 15px; padding-top: calc(20px + var(--safe-top)); z-index: 2000; transform: translateY(-100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; }
        #notif-banner.show { transform: translateY(0); }
        #notif-banner .notif-avatar { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: var(--accent); display: flex; align-items: center; justify-content: center; color: var(--accent-text); flex-shrink: 0; }
        #notif-banner .notif-content { flex: 1; }
        #notif-banner .notif-title { font-weight: 600; font-size: 0.9rem; }
        #notif-banner .notif-text { font-size: 0.8rem; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 250px; }
    </style>
</head>
<body oncontextmenu="return false;" data-accent="gold">

<!-- LOADER -->
<div id="loader">
    <div class="loader-icon"></div>
    <div class="loader-text">Meta Officiel</div>
    <div id="install-block-content" style="display:none; flex-direction: column; align-items: center;">
        <div class="install-block-text">
            <strong>Installation Requise pour iOS</strong><br><br>
            Pour les notifications et une exp√©rience optimale :
            <div class="install-steps">
                <div class="install-step">1. Appuyez sur l'ic√¥ne <strong>Partage</strong> <i class="fas fa-share" style="color: var(--accent);"></i> en bas de l'√©cran.</div>
                <div class="install-step">2. Faites d√©filer et appuyez sur <strong>"Sur l'√©cran d'accueil"</strong>.</div>
                <div class="install-step">3. Appuyez sur <strong>"Ajouter"</strong> en haut √† droite.</div>
            </div>
        </div>
    </div>
</div>

<!-- NOTIF BANNER -->
<div id="notif-banner" onclick="handleNotifClick()">
    <div class="notif-avatar"><i class="fas fa-user"></i></div>
    <div class="notif-content">
        <div class="notif-title">Nouveau message</div>
        <div class="notif-text">Cliquez pour voir...</div>
    </div>
</div>

<!-- ONBOARDING -->
<div id="onboarding-screen">
    <div class="ob-title">Meta Officiel</div>
    <div class="ob-subtitle">Personnalisation</div>
    <div id="ob-step-1" class="ob-step active">
        <div class="ob-subtitle" style="margin-bottom: 30px; font-size: 0.7rem;">Choisissez votre ambiance</div>
        <div class="ob-options">
            <button class="ob-btn" onclick="setObMode('dark')"><i class="fas fa-moon" style="margin-right: 10px;"></i> Mode Sombre</button>
            <button class="ob-btn" onclick="setObMode('light')"><i class="fas fa-sun" style="margin-right: 10px;"></i> Mode Clair</button>
        </div>
    </div>
    <div id="ob-step-2" class="ob-step">
        <div class="ob-subtitle" style="margin-bottom: 30px; font-size: 0.7rem;">S√©lectionnez l'accent</div>
        <div id="ob-color-container" class="color-options"></div>
        <button id="ob-validate-btn" class="ob-validate-btn" onclick="validateOnboarding()" disabled>Appliquer</button>
    </div>
</div>

<!-- LOGIN -->
<div id="login-screen">
    <div class="logo">Meta Officiel</div>
    <input type="text" id="username" placeholder="NOM D'UTILISATEUR" autocomplete="off">
    <input type="password" id="password" placeholder="MOT DE PASSE">
    <button class="login-btn btn-press" onclick="handleLogin()" style="margin-top: 20px;">Connexion</button>
    <div id="login-error">Acc√®s Refus√©</div>
</div>

<!-- APP -->
<div id="app-container">
    <div id="main-app">
        <header class="glass" id="main-header">
            <div class="header-left"><div style="width:35px;"></div></div>
            <span>Meta Officiel</span>
            <div class="header-right">
                <button id="global-cog" class="header-btn btn-press" style="display:none;" onclick="toggleSettings(true)"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div class="content-area">
            <div id="feed-section" class="section active">
                <div id="stories-list" class="stories-container"></div>
                <div id="photo-list"></div>
                <div style="height: 100px;"></div>
            </div>
            <div id="search-section" class="section">
                <div style="padding:15px; position:sticky; top:0; z-index:10; background:var(--bg-color);"><input type="text" id="search-input" style="width:100%; background:transparent; border-bottom:1px solid var(--border); border-top:none; border-left:none; border-right:none; text-align:left; font-size:1rem;" placeholder="Rechercher..." oninput="filtrerRecherche()"></div>
                <div id="search-results" style="padding-bottom: 100px;"></div>
            </div>
            <div id="videos-section" class="section"><div id="video-list" style="height: 100%;"></div></div>
            
            <div id="messages-section" class="section">
                <div class="msg-list-header glass">
                    <span class="msg-list-title">Messages</span>
                    <button class="header-btn btn-press" onclick="switchTab('feed', 0)"><i class="fas fa-times"></i></button>
                </div>
                <div id="msg-list-content" class="msg-list-content"></div>
            </div>

            <div id="own-profile-section" class="section">
                <div class="profile-header">
                    <div id="my-profile-pic-container" class="profile-pic-main"><i class="fas fa-user"></i></div>
                    <h2 id="my-name-display" style="font-weight: 300; font-size: 1.8rem; font-family: 'Cormorant Garamond', serif;"></h2>
                    <p id="my-handle-display" style="font-size: 0.8rem; color: var(--text-sec); margin-bottom: 25px; letter-spacing: 2px; text-transform: uppercase;"></p>
                    <div class="profile-stats">
                        <div class="stat-item"><span id="stat-posts" class="stat-num">0</span><span class="stat-label">Publications</span></div>
                        <div class="stat-item"><span id="stat-saved" class="stat-num">0</span><span class="stat-label">Enregistr√©s</span></div>
                    </div>
                    <button onclick="handleLogout()" class="btn-press" style="color: var(--text-sec); border:1px solid var(--border); padding:12px 30px; border-radius:12px; background:transparent; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px;">D√©connexion</button>
                </div>
                <div class="profile-tabs glass">
                    <button id="my-tab-pub" class="p-tab active" onclick="switchMyTab('info')">Publications</button>
                    <button id="my-tab-saved" class="p-tab" onclick="switchMyTab('saved')">Enregistr√©s</button>
                </div>
                <div id="my-posts-grid" class="content-grid"></div>
                <div id="my-saved-grid" class="content-grid" style="display:none;"></div>
            </div>

            <!-- OVERLAYS -->
            <div id="external-profile-overlay" class="overlay-page">
                <div class="glass" style="padding: 15px; display: flex; align-items: center; border-bottom: 1px solid var(--border);">
                    <button class="header-btn btn-press" onclick="closeExternalProfile()"><i class="fas fa-arrow-left"></i></button>
                    <span id="ext-user-title" style="margin-left: 10px; font-weight: 600; font-family: 'Cormorant Garamond';"></span>
                </div>
                <div id="ext-header" style="padding: 30px; text-align: center;">
                    <div id="ext-profile-pic-container" style="width: 80px; height: 80px; background: #222; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; border: 1px solid var(--accent);"><i class="fas fa-user"></i></div>
                    <h3 id="ext-display-name" style="font-size: 1.3rem; font-weight: 400; font-family: 'Cormorant Garamond', serif;"></h3>
                </div>
                <div class="profile-tabs"><div class="p-tab active">PUBLICATIONS</div></div>
                <div id="ext-posts-grid" class="content-grid"></div>
            </div>

            <div id="media-view-overlay" class="overlay-page">
                <div class="glass" style="padding: 15px; display: flex; align-items: center; border-bottom: 1px solid var(--border);">
                    <button class="header-btn btn-press" onclick="closeMediaView()"><i class="fas fa-arrow-left"></i></button>
                    <span style="margin-left: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem;">D√©tails</span>
                </div>
                <div id="media-view-content"></div>
            </div>

            <div id="settings-overlay" class="overlay-page">
                <div class="glass" style="padding:15px; display: flex; align-items: center; border-bottom: 1px solid var(--border);">
                    <button class="header-btn btn-press" onclick="toggleSettings(false)"><i class="fas fa-arrow-left"></i></button>
                    <h2 style="margin-left: 10px; font-size: 1.1rem; font-family: 'Cormorant Garamond';">Param√®tres</h2>
                </div>
                <div class="settings-group">
                    <div class="settings-title">Apparence</div>
                    <div class="settings-row">
                        <span class="settings-label">Th√®me</span>
                        <div style="display:flex; gap:10px;">
                            <button class="ob-btn" style="padding:8px 15px; font-size:0.7rem; border-radius:10px;" onclick="setThemeMode('dark')" id="btn-mode-dark">Sombre</button>
                            <button class="ob-btn" style="padding:8px 15px; font-size:0.7rem; border-radius:10px;" onclick="setThemeMode('light')" id="btn-mode-light">Clair</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Couleur</span>
                        <div id="settings-color-picker" class="picker-colors"></div>
                    </div>
                </div>
                <div class="settings-group">
                     <div class="settings-title">Notifications</div>
                     <div class="settings-row">
                         <span class="settings-label">Alertes Push</span>
                         <div id="notif-toggle" class="toggle-switch" onclick="toggleNotifSetting()">
                             <div class="toggle-knob"></div>
                         </div>
                     </div>
                     <p style="font-size:0.7rem; color:var(--text-sec); margin-top:5px; opacity:0.7;">Requis : App install√©e sur l'√©cran d'accueil.</p>
                </div>
            </div>
        </div>

        <!-- NAVIGATION -->
        <nav id="main-nav">
            <div class="nav-indicator" id="nav-indicator"></div>
            <button class="nav-item btn-press active" onclick="switchTab('feed', 0)"><i class="fas fa-house"></i></button>
            <button class="nav-item btn-press" onclick="switchTab('search', 1)"><i class="fas fa-magnifying-glass"></i></button>
            <button class="nav-item btn-press" onclick="switchTab('videos', 2)"><i class="fas fa-clapperboard"></i></button>
            <button class="nav-item btn-press" onclick="switchTab('messages', 3)"><i class="fas fa-paper-plane"></i></button>
            <button class="nav-item btn-press" onclick="switchTab('own-profile', 4)"><i class="fas fa-circle-user"></i></button>
        </nav>
    </div>
</div>

<!-- CHAT PAGE -->
<div id="chat-page">
    <div class="chat-top-bar glass">
        <span class="chat-top-title"><i class="fas fa-comments"></i> <span id="chat-target-name">Chat</span></span>
        <button class="chat-top-close" onclick="closeChatPage()"><i class="fas fa-arrow-left"></i></button>
    </div>
    <div id="chat-msg-area" class="chat-msg-area"></div>
    <div id="scroll-down-btn" class="scroll-down-btn" onclick="scrollChatBottom()"><i class="fas fa-chevron-down"></i></div>
    <div class="chat-input-container">
        <div id="chat-msg-preview" class="chat-msg-preview"></div>
        <div class="chat-input-row">
            <input type="text" id="chat-text-input" class="chat-text-input" placeholder="Message..." oninput="updateChatPreview()" onkeypress="if(event.key==='Enter')sendChatMsg()">
            <button class="chat-send-btn" onclick="sendChatMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // CONFIGURATION
    const SUPABASE_URL = 'https://lenzekscyrgevxpaxxms.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_pQp8C1jXKYac8Wwc9m8v4Q_j2c7xokr';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const GROQ_API_KEY = "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"; 
    const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
    const MODEL_NAME = "llama-3.1-8b-instant"; 

    const CONFIG_USERS = [
        { id: "metaservice", pass: "Pass.123", avatar: "", name: "Meta Service" },
        { id: "meta_actu", pass: "Pass.123", avatar: "https://fv5-5.files.fm/thumb_show.php?i=gp3yrtpv2u&view&v=1", name: "Meta Actu" },
        { id: "mazine2.0", pass: "mazine.123", avatar: "https://fv5-5.files.fm/thumb_show.php?i=hdv4muhgpy&view&v=1", name: "Mazine 2.0" },
        { id: "walid_hchm", pass: "Pass.123", avatar: "", name: "Walid Hchm" },
        { id: "user", pass: "12345", avatar: "", name: "Utilisateur" }
    ];

    const LISTE_PHOTOS = [ 
        { id: "meta_actu_fixe", url: "https://fv5-5.files.fm/thumb_show.php?i=gp3yrtpv2u&view&v=1", auteur: "meta_actu", date: 9999999 }, 
        { id: "p1", url: "https://fv5-5.files.fm/thumb_show.php?i=hdv4muhgpy&view&v=1", auteur: "mazine2.0", date: 550 }, 
        { id: "p2", url: "https://fv5-5.files.fm/thumb_show.php?i=rw3ztkktpt&view&v=1", auteur: "mazine2.0", date: 350 }, 
        { id: "p3", url: "https://fv5-5.files.fm/thumb_show.php?i=tbpxeusv7p&view&v=1", auteur: "user", date: 150 } 
    ];

    const LISTE_VIDEOS = [ 
        { id: "v0", auteur: "mazine2.0", vimeo_url: "https://player.cloudinary.com/embed/?cloud_name=di3uavh7l&public_id=9A7DD0EC-8A1F-4F23-ADE0-47D7AC52C80E_jix31x", thumb: "https://fv5-5.files.fm/thumb_show.php?i=hdv4muhgpy&view&v=1", legende: "Baston Abdelkabir vs El Gazzer", date: 800 }, 
        { id: "v1", auteur: "mazine2.0", vimeo_url: "https://player.cloudinary.com/embed/?cloud_name=di3uavh7l&public_id=WhatsApp_Video_2026-02-08_at_23.04.46_inqawp", thumb: "https://fv5-5.files.fm/thumb_show.php?i=hdv4muhgpy&view&v=1", legende: "üî•", date: 700 }, 
        { id: "v2", auteur: "mazine2.0", vimeo_url: "https://player.cloudinary.com/embed/?cloud_name=di3uavh7l&public_id=WhatsApp_Video_2026-02-09_at_23.40.08_zxllg0", thumb: "https://fv5-5.files.fm/thumb_show.php?i=hdv4muhgpy&view&v=1", legende: "ABO PRIME", date: 600 }, 
        { id: "v3", auteur: "mazine2.0", vimeo_url: "https://player.cloudinary.com/embed/?cloud_name=di3uavh7l&public_id=WhatsApp_Video_2026-02-08_at_22.24.50_vgmvka", thumb: "https://fv5-5.files.fm/thumb_show.php?i=hdv4muhgpy&view&v=1", legende: "EL GAZZER", date: 500 } 
    ];

    let loggedUser = localStorage.getItem("metaUser") || "";
    let savedItems = []; 
    let seenVideos = [];
    let videoObserver = null;
    let currentObMode = 'dark';
    let currentInput = "";
    let currentChatTarget = null;
    let chatInterval = null; 
    let lastNotifTime = 0;
    let lastKnownMessages = []; 

    function getUserById(id) { return CONFIG_USERS.find(u => u.id === id); }
    function getAvatar(userId) { const user = getUserById(userId); if (user && user.avatar) return `<img src="${user.avatar}" alt="${user.name}">`; return `<i class="fas fa-user"></i>`; }
    
    async function loadSavedItems() { if(!loggedUser) return; const { data, error } = await supabaseClient.from('saved_items').select('item_id').eq('user_id', loggedUser); if (!error) savedItems = data.map(i => i.item_id); }
    async function toggleSaveSupabase(id, btn) { const icon = btn.querySelector('i'); const isSaved = savedItems.includes(id); if (isSaved) { await supabaseClient.from('saved_items').delete().match({ user_id: loggedUser, item_id: id }); savedItems = savedItems.filter(i => i !== id); if(icon) icon.classList.replace('fas', 'far'); if(btn) btn.classList.remove('saved'); } else { await supabaseClient.from('saved_items').insert({ user_id: loggedUser, item_id: id }); savedItems.push(id); if(icon) icon.classList.replace('far', 'fas'); if(btn) btn.classList.add('saved'); } renderMyProfile(); }

    function renderMessagesList() { 
        const container = document.getElementById('msg-list-content'); 
        container.innerHTML = ""; 
        container.insertAdjacentHTML('beforeend', `<div class="msg-list-item" onclick="openChatWith('meta_ai')"><div class="msg-avatar"><i class="fas fa-wand-magic-sparkles"></i></div><div class="msg-info"><h4>Meta IA</h4><p>Discutez avec l'IA...</p></div></div>`); 
        container.insertAdjacentHTML('beforeend', `<div class="msg-list-item" onclick="openChatWith('metagodzilla_support')"><div class="msg-avatar" style="background: #2d2d2d;"><i class="fas fa-headset"></i></div><div class="msg-info"><h4>METAGODZILLA</h4><p>Centre d‚ÄôAide</p></div></div>`); 
        CONFIG_USERS.forEach(user => { if(user.id === loggedUser) return; container.insertAdjacentHTML('beforeend', `<div class="msg-list-item" onclick="openChatWith('${user.id}')"><div class="msg-avatar">${getAvatar(user.id)}</div><div class="msg-info"><h4>${user.name}</h4><p>Discuter</p></div></div>`); });
    }
    function filtrerRecherche() { const q = document.getElementById('search-input').value.toLowerCase(); const r = document.getElementById('search-results'); r.innerHTML = ""; if(q.length < 1) return; CONFIG_USERS.forEach(user => { if(user.name.toLowerCase().includes(q) || user.id.toLowerCase().includes(q)) { r.insertAdjacentHTML('beforeend', `<button style="padding:20px; cursor:pointer; background:transparent; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:15px; width:100%; text-align:left;" onclick="openExternalProfile('${user.id}')"><div class="mini-avatar" style="width:40px; height:40px; border-radius:50%; overflow:hidden; background:#222; display:flex; align-items:center; justify-content:center;">${getAvatar(user.id)}</div> <b style="color: var(--text-main); text-transform: uppercase; letter-spacing: 1px; font-weight: 500; font-size: 0.85rem;">${user.name}</b></button>`); } }); }

    function openChatWith(targetId) { 
        currentChatTarget = targetId; 
        let name = "Chat"; 
        if(targetId === 'meta_ai') name = "Meta IA"; else if(targetId === 'metagodzilla_support') name = "METAGODZILLA"; else name = getUserById(targetId).name; 
        document.getElementById('chat-target-name').innerText = name; 
        document.getElementById('chat-page').classList.add('active'); 
        document.body.classList.add('has-overlay'); 
        if(chatInterval) clearInterval(chatInterval);
        lastKnownMessages = []; 
        renderChatMessages(); 
        chatInterval = setInterval(renderChatMessages, 2000);
    }
    function closeChatPage() { if(chatInterval) clearInterval(chatInterval); document.getElementById('chat-page').classList.remove('active'); document.body.classList.remove('has-overlay'); renderMessagesList(); }
    
    function scrollChatBottom() { const area = document.getElementById('chat-msg-area'); area.scrollTop = area.scrollHeight; document.getElementById('scroll-down-btn').classList.remove('show'); }
    
    async function renderChatMessages() { 
        const area = document.getElementById('chat-msg-area'); 
        const isAtBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;
        const btn = document.getElementById('scroll-down-btn');
        if(!isAtBottom) btn.classList.add('show'); else btn.classList.remove('show');

        let msgs = [];
        
        if(currentChatTarget === 'meta_ai' || currentChatTarget === 'metagodzilla_support') {
            const chatKey = `chat_${loggedUser}_${currentChatTarget}`;
            msgs = JSON.parse(localStorage.getItem(chatKey)) || [];
        } else {
            const { data } = await supabaseClient.from('chats').select('*').or(`and(user_id.eq.${loggedUser},target_id.eq.${currentChatTarget}),and(user_id.eq.${currentChatTarget},target_id.eq.${loggedUser})`).order('created_at', { ascending: true });
            msgs = data || [];
        }

        const newContent = JSON.stringify(msgs);
        if (newContent === lastKnownMessages) return; 
        lastKnownMessages = newContent;

        area.innerHTML = ""; 
        if(currentChatTarget === 'metagodzilla_support' && msgs.length === 0) {
             area.innerHTML += `<div class="chat-msg-bubble bot">Tape le num√©ro correspondant √† ta question :\n\n1Ô∏è‚É£ Comment se d√©connecter ?\n\n2Ô∏è‚É£ Comment changer de th√®me ?\n\n3Ô∏è‚É£ Comment supprimer mon compte ?\n\n4Ô∏è‚É£ Comment supprimer une publication ?\n\n5Ô∏è‚É£ Comment signaler un probl√®me ?</div>`;
        } else if (msgs.length === 0) {
            area.innerHTML += `<div class="chat-msg-bubble other">D√©marrez la conversation.</div>`;
        } else {
            msgs.forEach(m => { 
                const cls = (m.sender === 'user' && m.user_id === loggedUser) ? 'user' : 'other'; 
                if(m.sender === 'bot') cls = 'bot';
                // Stocker le vrai ID de la DB ou le timestamp local
                const msgId = m.id || m.time; 
                // On passe le texte et l'ID √† la bulle
                const delBtn = (cls === 'user') ? `<div class="msg-delete-btn" onclick="deleteMsg(event, '${msgId}')">Effacer</div>` : '';
                area.innerHTML += `<div class="chat-msg-bubble ${cls}" ondblclick="toggleDeleteBtn(this)" data-msg-id="${msgId}">${m.text}${delBtn}</div>`; 
            });
        }

        if(isAtBottom || msgs.length === 0) area.scrollTop = area.scrollHeight; 
    }

    function toggleDeleteBtn(elem) {
        if(!elem.classList.contains('user')) return;
        document.querySelectorAll('.chat-msg-bubble').forEach(b => b.classList.remove('show-delete'));
        elem.classList.add('show-delete');
    }

    async function deleteMsg(e, id) {
        e.stopPropagation();
        if(!confirm("Supprimer ce message ?")) return;
        
        const bubble = e.target.closest('.chat-msg-bubble');
        if(bubble) bubble.remove();

        // 1. Essayer de supprimer de Supabase (vrai ID)
        if(currentChatTarget !== 'meta_ai' && currentChatTarget !== 'metagodzilla_support') {
            // On essaie de supprimer par l'ID num√©rique de la DB
            const parsedId = parseInt(id);
            if (!isNaN(parsedId)) {
                await supabaseClient.from('chats').delete().match({ id: parsedId });
            }
        } 
        
        // 2. Toujours nettoyer le LocalStorage (IA/Support ou fallback)
        let msgs = JSON.parse(localStorage.getItem(`chat_${loggedUser}_${currentChatTarget}`)) || [];
        msgs = msgs.filter(m => (m.time != id)); 
        localStorage.setItem(`chat_${loggedUser}_${currentChatTarget}`, JSON.stringify(msgs));
        
        lastKnownMessages = ""; // Force refresh
        renderChatMessages();
    }

    function showNotification(senderId, text) { const user = getUserById(senderId); const name = user ? user.name : "Inconnu"; const banner = document.getElementById('notif-banner'); banner.querySelector('.notif-title').innerText = name; banner.querySelector('.notif-text').innerText = text; banner.querySelector('.notif-avatar').innerHTML = getAvatar(senderId); banner.dataset.sender = senderId; banner.classList.add('show'); setTimeout(() => banner.classList.remove('show'), 3000); }
    function handleNotifClick() { const senderId = document.getElementById('notif-banner').dataset.sender; if(senderId) openChatWith(senderId); }
    
    function toggleNotifSetting() {
        const toggle = document.getElementById('notif-toggle');
        const isActive = toggle.classList.contains('active');
        if (isActive) { toggle.classList.remove('active'); localStorage.setItem('metaNotifs', 'disabled'); alert("Notifications d√©sactiv√©es."); } 
        else { requestPushPermission(); }
    }

    async function requestPushPermission() {
        if (!("Notification" in window)) { alert("Ce navigateur ne supporte pas les notifications."); return; }
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || ("standalone" in window.navigator) && window.navigator.standalone;
        if (isIos && !isStandalone) { alert("Sur iOS, vous devez d'abord ajouter l'app sur l'√©cran d'accueil pour activer les notifications."); return; }
        const permission = await Notification.requestPermission();
        if (permission === "granted") { document.getElementById('notif-toggle').classList.add('active'); localStorage.setItem('metaNotifs', 'enabled'); alert("Notifications activ√©es !"); } 
        else { document.getElementById('notif-toggle').classList.remove('active'); localStorage.setItem('metaNotifs', 'disabled'); alert("Autorisation refus√©e."); }
    }
    
    async function checkNotifs() {
        if(localStorage.getItem('metaNotifs') !== 'enabled') return;
        if (!loggedUser || Notification.permission !== "granted" || document.hasFocus()) return; 
        const { data } = await supabaseClient.from('chats').select('*').eq('target_id', loggedUser).order('created_at', { ascending: false }).limit(1);
        if(data && data.length > 0) {
             const lastMsg = data[0]; const lastTime = new Date(lastMsg.created_at).getTime();
             if(Date.now() - lastTime < 5000 && lastTime > lastNotifTime) { lastNotifTime = lastTime; const user = getUserById(lastMsg.user_id); new Notification("Nouveau message de " + (user ? user.name : "Inconnu"), { body: lastMsg.text, icon: user && user.avatar ? user.avatar : '' }); }
        }
    }
    setInterval(checkNotifs, 5000);

    function updateChatPreview() { currentInput = document.getElementById('chat-text-input').value; document.getElementById('chat-msg-preview').innerText = currentInput; }
    async function sendChatMsg() { 
        const text = currentInput.trim(); if(!text || !currentChatTarget) return; 
        const area = document.getElementById('chat-msg-area');
        area.innerHTML += `<div class="chat-msg-bubble user" ondblclick="toggleDeleteBtn(this)">${text}</div>`;
        scrollChatBottom(); 
        lastKnownMessages = ""; 
        document.getElementById('chat-text-input').value = ""; 
        updateChatPreview(); 

        if(currentChatTarget !== 'meta_ai' && currentChatTarget !== 'metagodzilla_support') {
            await supabaseClient.from('chats').insert({ user_id: loggedUser, target_id: currentChatTarget, sender: 'user', text: text });
        } else {
            let msgs = JSON.parse(localStorage.getItem(`chat_${loggedUser}_${currentChatTarget}`)) || [];
            msgs.push({sender: 'user', text: text, time: Date.now()});
            localStorage.setItem(`chat_${loggedUser}_${currentChatTarget}`, JSON.stringify(msgs));
        }

        if(currentChatTarget === 'meta_ai') { 
            area.innerHTML += `<div class="chat-msg-bubble bot">...</div>`; scrollChatBottom();
            try { 
                const response = await fetch(GROQ_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` }, body: JSON.stringify({ model: MODEL_NAME, messages: [{role: "user", content: text}] }) }); 
                const data = await response.json(); 
                const botText = data.choices[0].message.content;
                document.querySelector('.chat-msg-bubble.bot:last-child').innerText = botText;
                let msgs = JSON.parse(localStorage.getItem(`chat_${loggedUser}_${currentChatTarget}`)) || [];
                msgs.push({sender: 'bot', text: botText, time: Date.now()});
                localStorage.setItem(`chat_${loggedUser}_${currentChatTarget}`, JSON.stringify(msgs));
                lastKnownMessages = ""; scrollChatBottom();
            } catch(e) { document.querySelector('.chat-msg-bubble.bot:last-child').innerText = "Erreur."; } 
        } else if (currentChatTarget === 'metagodzilla_support') {
            let r = "Je ne comprends pas."; if(text === '1') r = "Profil > D√©connexion."; else if(text === '2') r = "Profil > Param√®tres."; else if(['3','4','5'].includes(text)) r = "Contact: metaserviceofficiel@gmail.com";
            area.innerHTML += `<div class="chat-msg-bubble bot">${r}</div>`; 
            let msgs = JSON.parse(localStorage.getItem(`chat_${loggedUser}_${currentChatTarget}`)) || []; msgs.push({sender: 'bot', text: r, time: Date.now()}); localStorage.setItem(`chat_${loggedUser}_${currentChatTarget}`, JSON.stringify(msgs));
            lastKnownMessages = ""; scrollChatBottom();
        }
    }

    // APP LOGIC
    function setViewportHeight() { let vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
    window.addEventListener('resize', setViewportHeight);
    function applyTheme(mode, accent) { if (mode === 'light') document.body.classList.add('light-mode'); else document.body.classList.remove('light-mode'); document.body.setAttribute('data-accent', accent); localStorage.setItem('metaThemeMode', mode); localStorage.setItem('metaThemeAccent', accent); }
    function setObMode(mode) { currentObMode = mode; document.getElementById('ob-step-1').classList.remove('active'); document.getElementById('ob-step-2').classList.add('active'); const container = document.getElementById('ob-color-container'); container.innerHTML = ''; let colors = (mode === 'dark') ? [{ id: 'gold', name: 'Or', class: 'cc-gold' }, { id: 'blue', name: 'Bleu', class: 'cc-blue' }, { id: 'white', name: 'Blanc', class: 'cc-white' }] : [{ id: 'black', name: 'Noir', class: 'cc-black' }, { id: 'blue', name: 'Bleu', class: 'cc-blue' }, { id: 'grey', name: 'Gris', class: 'cc-grey' }]; colors.forEach(c => { container.innerHTML += `<div class="color-circle ${c.class}" onclick="selectObColor('${c.id}', this)">${c.name}</div>`; }); }
    let selectedObColor = null;
    function selectObColor(color, elem) { document.querySelectorAll('#ob-color-container .color-circle').forEach(e => e.classList.remove('active')); elem.classList.add('active'); selectedObColor = color; document.getElementById('ob-validate-btn').disabled = false; }
    function validateOnboarding() { if (!selectedObColor) return; applyTheme(currentObMode, selectedObColor); document.getElementById('onboarding-screen').style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; }
    async function handleLogin() { const u = document.getElementById("username").value.trim().toLowerCase(); const p = document.getElementById("password").value; const user = getUserById(u); if (user && user.pass === p) { localStorage.setItem("metaUser", u); loggedUser = u; seenVideos = JSON.parse(localStorage.getItem(`seen_${loggedUser}`)) || []; await loadSavedItems(); startApp(); } else { document.getElementById("login-error").style.display = "block"; } }
    async function startApp() { 
        document.getElementById("login-screen").style.display = "none"; 
        document.getElementById("main-app").style.display = "flex"; 
        document.querySelector("header").style.display = "flex"; 
        const user = getUserById(loggedUser); 
        if(user) { document.getElementById("my-name-display").innerText = user.name; document.getElementById("my-handle-display").innerText = "@" + user.id; document.getElementById("my-profile-pic-container").innerHTML = getAvatar(loggedUser); } 
        renderStories(); renderMessagesList(); renderContent(); renderMyProfile(); switchTab('feed', 0); updateSettingsUI(); 
        const notifState = localStorage.getItem('metaNotifs'); const toggle = document.getElementById('notif-toggle'); if(notifState === 'enabled' && Notification.permission === 'granted') toggle.classList.add('active'); else toggle.classList.remove('active');
    }
    function switchTab(t, i) { 
        document.getElementById('settings-overlay').classList.remove('active'); document.getElementById('external-profile-overlay').classList.remove('active'); document.getElementById('media-view-overlay').classList.remove('active'); closeChatPage(); document.body.classList.remove('has-overlay'); 
        if (t === 'settings') { document.getElementById('settings-overlay').classList.add('active'); updateSettingsUI(); document.body.classList.add('has-overlay'); return; } 
        if (t === 'external-profile') { document.getElementById('external-profile-overlay').classList.add('active'); document.body.classList.add('has-overlay'); return; } 
        if (t === 'media-view') { document.getElementById('media-view-overlay').classList.add('active'); document.body.classList.add('has-overlay'); return; } 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        if(document.getElementById(t + '-section')) document.getElementById(t + '-section').classList.add('active'); 
        document.querySelectorAll('nav button.nav-item').forEach((btn, idx) => btn.classList.toggle('active', idx === i)); 
        document.getElementById('main-header').style.display = (t === 'videos') ? "none" : "flex"; document.getElementById('global-cog').style.display = (t === 'own-profile') ? "block" : "none"; moveIndicator(i); if (t !== 'videos') stopAllVideos(); else setTimeout(observeVideos, 100); 
    }
    function moveIndicator(i) { const b = document.querySelectorAll('nav button.nav-item'); const ind = document.getElementById('nav-indicator'); if(b[i]) { const r = b[i].getBoundingClientRect(); const nR = b[i].parentElement.getBoundingClientRect(); ind.style.left = (r.left - nR.left + r.width/2 - 12.5) + 'px'; } }
    function stopAllVideos() { document.querySelectorAll('.video-card').forEach(vc => { vc.classList.remove('playing'); const iframe = vc.querySelector('iframe'); if(iframe) iframe.src = ""; }); }
    function observeVideos() { if (videoObserver) videoObserver.disconnect(); const cards = document.querySelectorAll('.video-card'); videoObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { const card = entry.target; const videoId = card.getAttribute('data-id'); if (entry.isIntersecting) { if(!card.classList.contains('playing')) { card.classList.add('playing'); const iframe = card.querySelector('iframe'); const targetSrc = iframe.getAttribute('data-src'); if(iframe.src === "" || iframe.src !== targetSrc) iframe.src = targetSrc; setTimeout(() => { try { iframe.contentWindow.postMessage('{"method":"play"}', '*'); } catch(e) {} }, 200); } if(videoId && !seenVideos.includes(videoId)) { seenVideos.push(videoId); localStorage.setItem(`seen_${loggedUser}`, JSON.stringify(seenVideos)); const badge = card.querySelector('.seen-badge'); if(badge) badge.style.display = 'none'; } } else { if(card.classList.contains('playing')) { card.classList.remove('playing'); const iframe = card.querySelector('iframe'); try { iframe.contentWindow.postMessage('{"method":"pause"}', '*'); } catch(e) {} iframe.src = ""; } } }); }, { threshold: 0.6 }); cards.forEach(card => videoObserver.observe(card)); }
    function openExternalProfile(userId) { if(userId === loggedUser) { switchTab('own-profile', 4); return; } const user = getUserById(userId); if(!user) return; const o = document.getElementById('external-profile-overlay'); document.getElementById('ext-user-title').innerText = user.name; document.getElementById('ext-display-name').innerText = user.name; document.getElementById('ext-profile-pic-container').innerHTML = getAvatar(userId); const g = document.getElementById('ext-posts-grid'); g.innerHTML = ""; const m = [...LISTE_PHOTOS.filter(p => p.auteur === userId).map(p => ({...p, type:'photo'})), ...LISTE_VIDEOS.filter(v => v.auteur === userId).map(v => ({...v, type:'video'}))].sort((a,b) => b.date - a.date); if (m.length === 0) g.innerHTML = `<div class="empty-state">Aucune publication</div>`; else m.forEach(m => { g.insertAdjacentHTML('beforeend', `<button class="grid-item" onclick="switchTab('media-view'); openMediaView('${m.id}', '${m.type}')">${m.type==='photo'?`<img src="${m.url}">`:`<img src="${m.thumb}"><i class="vid-icon fas fa-play"></i>`}</button>`); }); o.classList.add('active'); document.body.classList.add('has-overlay'); }
    function closeExternalProfile() { document.getElementById('external-profile-overlay').classList.remove('active'); document.body.classList.remove('has-overlay'); }
    function renderMyProfile() { const gP = document.getElementById('my-posts-grid'); const gS = document.getElementById('my-saved-grid'); gP.innerHTML = ""; gS.innerHTML = ""; const mP = LISTE_PHOTOS.filter(p => p.auteur === loggedUser); document.getElementById('stat-posts').innerText = mP.length; document.getElementById('stat-saved').innerText = savedItems.length; if (mP.length === 0) gP.innerHTML = `<div class="empty-state">Aucune publication</div>`; else mP.forEach(p => { gP.insertAdjacentHTML('beforeend', `<button class="grid-item" onclick="switchTab('media-view'); openMediaView('${p.id}', 'photo')"><img src="${p.url}"></button>`); }); if (savedItems.length === 0) gS.innerHTML = `<div class="empty-state">Aucun √©l√©ment enregistr√©</div>`; else { savedItems.forEach(id => { let item = LISTE_PHOTOS.find(p => p.id === id); let type = 'photo'; if(!item) { item = LISTE_VIDEOS.find(v => v.id === id); type = 'video'; } if(item) { gS.insertAdjacentHTML('beforeend', `<button class="grid-item" onclick="switchTab('media-view'); openMediaView('${item.id}', '${type}')">${type==='photo'?`<img src="${item.url}">`:`<img src="${item.thumb}"><i class="vid-icon fas fa-play"></i>`}</button>`); } }); } }
    function switchMyTab(t) { document.getElementById('my-tab-pub').classList.toggle('active', t === 'info'); document.getElementById('my-tab-saved').classList.toggle('active', t === 'saved'); document.getElementById('my-posts-grid').style.display = t === 'info' ? 'grid' : 'none'; document.getElementById('my-saved-grid').style.display = t === 'saved' ? 'grid' : 'none'; }
    function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
    function renderContent() { 
        const pD = document.getElementById('photo-list'); const vD = document.getElementById('video-list'); pD.innerHTML = ""; vD.innerHTML = ""; 
        const pM = LISTE_PHOTOS.find(p => p.id === "meta_actu_fixe"); const aP = LISTE_PHOTOS.filter(p => p.id !== "meta_actu_fixe"); const sP = shuffleArray([...aP]); const fF = pM ? [pM, ...sP] : sP; 
        fF.forEach(p => { const iS = savedItems.includes(p.id); pD.insertAdjacentHTML('beforeend', `<article class="post"><div class="post-user" onclick="openExternalProfile('${p.auteur}')"><div class="mini-avatar">${getAvatar(p.auteur)}</div> ${getUserById(p.auteur).name}</div><div class="post-img-container" ondblclick="animateLike(this)"><img src="${p.url}"><div class="like-overlay"><i class="fas fa-heart" style="font-size: 4rem;"></i></div></div><div class="post-actions"><button class="action-btn btn-press ${iS ? 'saved' : ''}" onclick="toggleSaveSupabase('${p.id}', this)"><i class="${iS ? 'fas' : 'far'} fa-bookmark"></i></button></div></article>`); }); 
        const allVids = shuffleArray([...LISTE_VIDEOS]);
        allVids.forEach(v => { const hBS = seenVideos.includes(v.id); const iS = savedItems.includes(v.id); vD.insertAdjacentHTML('beforeend', `<div class="video-card" data-id="${v.id}"><img class="video-thumb" src="${v.thumb}"><div class="video-play-overlay"><i class="fas fa-play"></i></div><iframe data-src="${v.vimeo_url}&autoplay=1" src="" frameborder="0" allow="autoplay; fullscreen"></iframe><div class="video-info"><h3>@${getUserById(v.auteur).name}</h3><p>${v.legende}</p></div><div class="video-sidebar"><button class="sidebar-btn ${iS ? 'saved' : ''}" onclick="toggleSaveSupabase('${v.id}', this)"><i class="${iS ? 'fas' : 'far'} fa-bookmark"></i><span>Save</span></button></div>${hBS ? '<div class="seen-badge">Vu</div>' : ''}</div>`); }); 
        setTimeout(observeVideos, 500); 
    }
    function animateLike(c) { const o = c.querySelector('.like-overlay'); o.classList.remove('animate'); void o.offsetWidth; o.classList.add('animate'); }
    async function openMediaView(id, type) { const o = document.getElementById('media-view-overlay'); const c = document.getElementById('media-view-content'); let it = (type === 'photo') ? LISTE_PHOTOS.find(p => p.id === id) : LISTE_VIDEOS.find(v => v.id === id); if(it) { const iS = savedItems.includes(it.id); c.innerHTML = `<article class="post"><div class="post-user" onclick="openExternalProfile('${it.auteur}')"><div class="mini-avatar">${getAvatar(it.auteur)}</div> ${getUserById(it.auteur).name}</div>${type==='photo'?`<img src="${it.url}" style="width:100%">`:`<iframe src="${it.vimeo_url}&autoplay=1" style="width:100%;height:450px;" allow="autoplay; fullscreen"></iframe>`}<div class="post-actions"><button class="action-btn btn-press ${iS ? 'saved' : ''}" onclick="toggleSaveSupabase('${it.id}', this)"><i class="${iS ? 'fas' : 'far'} fa-bookmark"></i></button></div></article>`; o.classList.add('active'); document.body.classList.add('has-overlay'); }}
    function closeMediaView() { document.getElementById('media-view-overlay').classList.remove('active'); document.querySelectorAll('#media-view-content iframe').forEach(f => f.src = ""); document.body.classList.remove('has-overlay'); }
    function toggleSettings(s) { if(s) { document.getElementById('settings-overlay').classList.add('active'); document.body.classList.add('has-overlay'); } else { document.getElementById('settings-overlay').classList.remove('active'); document.body.classList.remove('has-overlay'); } updateSettingsUI(); }
    function setThemeMode(mode) { let cA = localStorage.getItem('metaThemeAccent') || 'gold'; if(mode === 'light' && (cA === 'white' || cA === 'gold')) cA = 'black'; if(mode === 'dark' && cA === 'black') cA = 'gold'; applyTheme(mode, cA); updateSettingsUI(); }
    function setThemeAccent(accent) { const m = localStorage.getItem('metaThemeMode') || 'dark'; applyTheme(m, accent); updateSettingsUI(); }
    function updateSettingsUI() { const m = localStorage.getItem('metaThemeMode') || 'dark'; const a = localStorage.getItem('metaThemeAccent') || 'gold'; document.getElementById('btn-mode-dark').classList.toggle('selected', m === 'dark'); document.getElementById('btn-mode-light').classList.toggle('selected', m === 'light'); const p = document.getElementById('settings-color-picker'); p.innerHTML = ''; let c = (m === 'dark') ? [{id:'gold', class:'cc-gold'}, {id:'blue', class:'cc-blue'}, {id:'white', class:'cc-white'}] : [{id:'black', class:'cc-black'}, {id:'blue', class:'cc-blue'}, {id:'grey', class:'cc-grey'}]; c.forEach(c => { p.innerHTML += `<div class="picker-circle ${c.class} ${(c.id === a)?'active':''}" onclick="setThemeAccent('${c.id}')"></div>`; }); }
    function handleLogout() { localStorage.removeItem("metaUser"); location.reload(); }
    function renderStories() { const container = document.getElementById('stories-list'); container.innerHTML = ""; CONFIG_USERS.forEach(user => { container.insertAdjacentHTML('beforeend', `<button class="story-bubble btn-press" onclick="openExternalProfile('${user.id}')"><div class="story-img-wrapper">${getAvatar(user.id)}</div><div class="story-name">${user.name}</div></button>`); }); }

    // START
    window.addEventListener('load', async () => {
        setViewportHeight();
        setTimeout(() => { window.scrollTo(0, 0); document.body.style.transform = 'scale(1)'; }, 100);
        if(loggedUser) { await loadSavedItems(); seenVideos = JSON.parse(localStorage.getItem(`seen_${loggedUser}`)) || []; }
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches; const isIosWebApp = ("standalone" in window.navigator) && (window.navigator.standalone === true); const isAndroidApp = document.referrer.startsWith('android-app://'); const appLaunched = isStandalone || isIosWebApp || isAndroidApp; const isAndroid = /Android/i.test(navigator.userAgent);
            if (appLaunched || isAndroid) { const hasPrefs = localStorage.getItem('metaThemeMode'); if (!hasPrefs) document.getElementById('onboarding-screen').style.display = 'flex'; else { applyTheme(hasPrefs, localStorage.getItem('metaThemeAccent')); if(loggedUser) startApp(); else document.getElementById('login-screen').style.display = 'flex'; } }
            else if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) { document.getElementById('loader').style.display = 'flex'; document.getElementById('install-block-content').style.display = 'flex'; }
            else { const hasPrefs = localStorage.getItem('metaThemeMode'); if (!hasPrefs) document.getElementById('onboarding-screen').style.display = 'flex'; else { applyTheme(hasPrefs, localStorage.getItem('metaThemeAccent')); if(loggedUser) startApp(); else document.getElementById('login-screen').style.display = 'flex'; } }
        }, 1500);
    });
</script>
</body>
</html>
